---
title: 2. React å®ç°é¡¹ç›®(åå°ç®¡ç†)
meta:
  - bgImage: http://pic.closeeyes.cn/react2.jpg
tag: React
---

### å‰æ²¿

ç”±äºæ¥è§¦`vue`è¾ƒå¤šï¼Œå·¥ä½œä¸­ä¹Ÿæ˜¯ç”¨`vue`åšçš„åå°ç®¡ç†ï¼Œæœ€è¿‘é—²ä¸‹æ¥äº†ï¼Œå°±æƒ³ç€å­¦ä¹ ä¸‹`React`ï¼Œåœ¨è¿™é‡Œè®°å½•ä¸‹åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­çš„é‡åˆ°çš„é—®é¢˜ï¼Œä»¥åŠç¬”è®°ã€‚

+ é¡¹ç›®ä¸­ä¹Ÿå‚è€ƒçš„`github`ä¸­çš„é¡¹ç›®[react-admin](https://github.com/yezihaohao/react-admin)å†æ¬¡è¡¨ç¤ºå¤§å¤§çš„æ„Ÿè°¢ğŸ˜„
+ é¡¹ç›®ä¸­çš„mockæ•°æ®æ˜¯å€Ÿç”¨äº† [easy-mock](https://www.easy-mock.com/) ï¼ˆç”±äºæœ‰æ—¶å€™è¯·æ±‚ä¸ç¨³å®šä¹Ÿä¼šæ¢ï¼‰[fastmock](https://www.fastmock.site)ã€‚
+ åœ¨çº¿ä½“éªŒåœ°å€ [https://react.closeeyes.cn](https://react.closeeyes.cn)
+ [githubå®Œæ•´ä»£ç ğŸ›](https://github.com/hz199/__react-admin-zh-redux)

#### 1. ç›®å½•ç»“æ„

ç”±äºä¹Ÿæ˜¯åˆšæ¥è§¦`react`å°±ç›´æ¥ä½¿ç”¨`create-react-app`å®˜æ–¹çš„è„šæ‰‹æ¶äº†ï¼Œç”±äºéœ€è¦åšä¸€äº›è‡ªå®šä¹‰é…ç½®ç›´æ¥`yarn eject`æŠŠwebpackç›¸å…³é…ç½®æš´éœ²å‡ºæ¥ã€‚æ•´ç†åçš„ç›®å½•ç»“æ„å¦‚ä¸‹å›¾ï¼š

![image](http://study.closeeyes.cn/react-admin.jpeg)

åœ¨è¿™é‡Œå°±ç®€å•ä»‹ç»ä¸‹ç›®å½•ç»“æ„
- `build`: æ‰“åŒ…ä¹‹åçš„ä»£ç å­˜åœ¨çš„ç›®å½•
- `config`: webpack ç›¸å…³é…ç½®
- `scripts`: webpack æ‰“åŒ…ä»¥åŠå¼€å‘å¯åŠ¨ç›®å½•
- `CNAME`: ç”±äºæ‰“åŒ…åçš„æ–‡ä»¶æ˜¯ `GitHub Pages` ç»‘å®šæ¥è‡ªé˜¿é‡Œäº‘çš„åŸŸåï¼Œåœ¨è¿™é‡Œé…ç½®ä¸‹
- `deploy.sh`: æ‰“åŒ…åçš„æ–‡ä»¶å‘å¸ƒåˆ° `GitHub Pages`ç›¸å…³æ“ä½œ

> `src`ç›®å½•æ˜¯æˆ‘ä»¬çš„æºä»£ç æ‰€å¤„çš„ä½ç½®

- `containers`: é¡µé¢æ‰€å¤„çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯åå°ç®¡ç†çš„å†…å®¹åŒºåŸŸã€‚
- `services`: ä¸`ajax`ç›¸å…³é…ç½®

#### 2. è·¯ç”±æ‹¦æˆªä¸è·¯ç”±çš„æ‡’åŠ è½½

æˆ‘ä»¬åšåå°ç®¡ç†æœ‰æ—¶å€™æƒ³è¦åœ¨è¿›å…¥é¡µé¢ä¹‹å‰åšç‚¹ä»€ä¹ˆï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šç”¨åˆ°è·¯ç”±æ‹¦æˆªï¼Œ`react-router-dom`æ²¡æœ‰åƒ`Vue-router`é‚£æ ·çš„`beforeRouter`ç”Ÿå‘½å‘¨æœŸçš„é’©å­å‡½æ•°ï¼Œé‚£å°±éœ€è¦æˆ‘ä»¬è‡ªå·±æ¥åšè¿™ä»¶äº‹æƒ…äº†ï¼Œå°è¯•äº†å¾ˆå¤šåŠæ³•ï¼Œæ€»ç®—æ˜¯æŠŠè¿™ä¸ªäº‹æƒ…è§£å†³äº†ï¼Œå…ˆçœ‹ä»£ç ï¼š 

```jsx

// react-loadable æ˜¯ä¸€ä¸ªåŠ¨æ€å¯¼å…¥åŠ è½½ç»„ä»¶çš„é«˜é˜¶ç»„ä»¶.
// ä¸€ä¸ªç»„ä»¶æ˜¯importçš„ç»„ä»¶ï¼Œå¦ä¸€ä¸ªæ˜¯æ¸²æŸ“ç»„ä»¶  å½“ç”¨æˆ·è¿›å…¥é¡µé¢æ˜¯ åŠ è½½å¼‚æ­¥ç»„ä»¶ï¼Œé¡µé¢ä¸­æ˜¾ç¤ºçš„åªæ˜¯ loading....

import React from 'react'
import loadable from 'react-loadable'

function asyncImport(loader) {
  function Loading(props) {
    if (props.error)
      return <div> Error! </div>
    else if (props.pastDelay)
      return (
        <div>
          æ­£åœ¨åŠ è½½ç»„ä»¶æ•°æ®...
        </div>
      )
    else
      return null
  }

  return loadable({
    loader,
    loading: Loading,
  })
}

export {
  asyncImport
}

```

```js

import { asyncImport } from '../utils/routerLoadable'

// è¿™é‡Œä¹ æƒ¯æ€§çš„ä½¿ç”¨ å®šä¹‰vue-router çš„è§„åˆ™
const routes = [
  {
    name: 'Home',
    path: '/app',
    component: asyncImport(() => import('../containers/Home')),
    meta: {
      title: 'é¦–é¡µ',
      rules: ['loginRequired']
    }
  },
  {
    name: 'Home1',
    path: '/app1',
    component: asyncImport(() => import('../containers/Home1')),
    meta: {
      title: 'é¦–é¡µ1',
      rules: []
    }
  },
  // .......
]

export default routes
```

```jsx

import React from 'react'
import { Route, Switch, Redirect } from 'react-router-dom'
import routes from './api'
import queryString from 'query-string'

// æƒé™é™åˆ¶è§„åˆ™
const requiredRules = {
  /** 
   * åˆ¤æ–­æ˜¯å¦ç™»å½•
   * @return true æ¡ä»¶æ»¡è¶³ é€šè¿‡æƒé™éªŒè¯
   */
  loginRequired (path) {
    const localStorage = window.localStorage
    const strReactAdminUserInfo = localStorage.getItem('react-admin_user') || '{}'
    const reactAdminUserInfo = JSON.parse(strReactAdminUserInfo)
    return !!reactAdminUserInfo.userName || '/login'
  }
}

/**
 * @param  {Protected:ç™»é™†æ‹¦æˆªï¼ˆå‡½æ•°ç»„å»ºï¼‰}
 * @return {è¿˜æ˜¯ä¸€ä¸ªRouteç»„ä»¶ï¼Œè¿™ä¸ªRouteç»„å»ºä½¿ç”¨çš„æ˜¯Routeä¸‰å¤§æ¸²æŸ“æ–¹å¼ï¼ˆcomponentã€renderã€childrenï¼‰çš„renderæ–¹å¼}
 */
const Protected =  ({component: Comp, ...rest}) => {

  const { exact, path, meta, setTagPage, ...otherRest } = rest
  return (
    <Route {...rest} render={ () => {
      const { title } = meta
      document.title = title || 'react-admin'

      // è·¯ç”±æ‹¦æˆª è¿›å…¥é¡µé¢å‰ æ£€æŸ¥ é€ä¸ªè°ƒç”¨ metaé‡Œé¢çš„ rules çš„è§„åˆ™. 
      // eg: /app è·¯ç”± rulesæ˜¯ ['loginRequired'], å­˜åœ¨ç™»å½•éªŒè¯è§„åˆ™ï¼Œ è¿›å…¥é¡µé¢ä¹‹å‰ä¼šéªŒè¯æ˜¯å¦ç™»å½•
      if (meta.rules && meta.rules instanceof Array) {
        const middlewares = meta.rules.map(item => requiredRules[item])
        for (let i = 0; i < middlewares.length; i++) {
          const result = middlewares[i](path)
      
          if (result) {
            return <Redirect to={result}/>
          }
        }
      }

      return <Comp {...otherRest}/>
    }}/>
  )
}

const routerApp = (props) => {
  const query = queryString.parse(props.location.search)
  props.match.query = query
  return (
    <Switch>
      {
        routes.map((item) => (
          <Protected
            {...props}
            path={ item.path }
            component={ item.component }
            key={ item.path }
            exact
            meta={item.meta}>
          </Protected>
        ))
      }
      <Route render={() => <Redirect to='/404'/>} />
    </Switch>
  )
}

export default routerApp
```

#### 3. axios è¯·æ±‚æ‹¦æˆª

```js

// LoadingBar æ˜¯è‡ªå·±å†™çš„ä¸€ä¸ªReactç»„ä»¶

import axios from 'axios'
import LoadingBar from '@/components/LoadingBar'

let apiBaseURL = 'https://www.easy-mock.com/mock/5d088415bdc26d23199ba01a'
// const apiBaseURL = 'https://www.fastmock.site/mock/4dcea17ec42f04835302140b4dadeacc'

const instance = axios.create({
  baseURL: apiBaseURL,
  timeout: 5000
})

// request
instance.interceptors.request.use((config) => {
  LoadingBar.start()
  return config
}, (err) => {
  LoadingBar.error()
  return Promise.reject(err)
})

// response
instance.interceptors.response.use((response) => {
  LoadingBar.finish()
  return response.data
}, (err) => {
  LoadingBar.error()
  return Promise.reject(err)
})

export default instance

```

#### 4. redux

è¯¦ç»†è¯·è·³è½¬ [ä¼ é€é—¨](./01.md)

#### 5. `css` æ¨¡å—åŒ– ç±»ä¼¼ä¸`Vue`çš„ `scope`

`reactjs`æ²¡æœ‰åƒ`vue style scoped`é‚£æ ·ç®€å•çš„é…ç½®å°±èƒ½å®ç°css æ¨¡å—åŒ–äº†ï¼Œåœ¨è¿™é‡Œæ˜¯å€ŸåŠ©äº†ç¬¬ä¸‰æ–¹çš„æ’ä»¶ `babel-plugin-react-css-modules` å®ç°css æ¨¡å—åŒ–ã€‚
é…ç½®è¿‡ç¨‹ä¸­ä¹Ÿé‡åˆ°äº†ä¸€äº›å‘~

- `create-react-app`åœ¨åˆ›å»ºé¡¹ç›®çš„æ—¶å€™å·²ç»åšäº†æ¨¡å—åŒ–å¤„ç†ï¼Œé»˜è®¤åŒ¹é…`*.module.(less|sass|css)çš„æ–‡ä»¶åšæ¨¡å—åŒ–å¤„ç†`
```js

const cssRegex = /\.css$/;
const cssModuleRegex = /\.module\.css$/;
const sassRegex = /\.(scss|sass)$/;
const sassModuleRegex = /\.module\.(scss|sass)$/;

// è¿™é‡Œæ˜¯è‡ªå·±æ·»åŠ çš„lessé…ç½®
const lessRegex = /\.(less)$/;
const lessModuleRegex = /\.module\.(less)$/;
```
å¦‚æœä¸åšä¸€äº›å¤„ç†çš„è¯ä½¿ç”¨æ–¹æ³•, è¿™æ ·å†™`className`åªèƒ½å†™é©¼å³°ï¼Œä¹¦å†™éº»çƒ¦
```jsx

import React from 'react'
import cssModule from './index.module.less'

const CssModules = (props) => {
  return (
    <div className={cssModule.className}>CssModules</div>
  )
}

export default CssModules
```
- é…ç½® `babel-plugin-react-css-modules`

```bash
yarn add babel-plugin-react-css-modules  postcss-less -D
```
- webpacké…ç½®
```js
{
  test: lessModuleRegex,
  use: getStyleLoaders({
    importLoaders: 2,
    modules: true,
    // getLocalIdent: getCSSModuleLocalIdent,
    localIdentName: '[path][name]__[local]',
    sourceMap: isEnvProduction && shouldUseSourceMap,
  },
    'less-loader'
  ),
},
```
- `.babelrc.js`
```js

module.exports = {
  "presets": [
    "react-app"
  ],
  "plugins": [
    [
      "@babel/plugin-proposal-decorators",
      {
        "legacy": true
      }
    ],
    [
      "react-css-modules",
      {
        "exclude": 'node_modules',
        "generateScopedName": '[path][name]__[local]',
        "filetypes": {
          ".less": {
            "syntax": "postcss-less"
          }
        }
      }
    ]
  ]
}
```
- cssåå­—çš„è§„åˆ™ `[path][name]__[local]`
>  `babel generateScopedName` ä¸ webpack css-loader é…ç½®çš„ `localIdentName`è¦ä¿æŒä¸€è‡´, æœ¬æ¥è¦é…ç½®ä¸åŒçš„hashå€¼ç¡®ä¿çœŸæ­£çš„åå­—ä¸é‡å¤` [path][name]__[local]__[hash:8]` ç»“æœæ‰“åŒ…å‡ºæ¥çš„ä»£ç  cssæ ·å¼ class ä¸ htmlå±æ€§çš„class åå­—hashä¸ä¸€è‡´ï¼Œ ä¸çŸ¥é“æ€ä¹ˆè§£å†³ï¼Œæœªå®Œå¾…ç»­~~ TODOã€‚

é…ç½®å®Œæˆçš„ä»£ç å¦‚ä¸‹
```jsx

import React from 'react'
import './index.module.less'

// ä½¿ç”¨äº† styleName çš„ç±»åå°±æ˜¯æ¨¡å—åŒ–çš„class é€šæ—¶ä¹Ÿå¯ä»¥ä¸classNameæ··åˆä½¿ç”¨

const CssModules = (props) => {
  return (
    <div styleName="css-module">CssModules</div>
  )
}

export default CssModules
```