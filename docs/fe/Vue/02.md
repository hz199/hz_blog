---
title: 2. Vue.extend å®ç° $Message ç»„ä»¶
meta: 
  - bgImage: http://pic.closeeyes.cn/vue2.jpg
tag: Vue
---

###  Vue.extend å®ç° $Message ç»„ä»¶


>é€šå¸¸æˆ‘ä»¬ä½¿ç”¨Vueç»„ä»¶æ˜¯åˆ›å»ºä¸€ä¸ª`.vue`çš„æ–‡ä»¶ã€‚å¦‚æœæˆ‘ä»¬è¦åˆ›å»ºåƒ[Iview.$Message.success()](https://www.iviewui.com/components/message)å‡½æ•°å¼è°ƒç”¨çš„ç»„ä»¶æˆ‘ä»¬è¦æ€ä¹ˆåˆ›å»ºå‘¢ï¼Œè¿™é‡Œä½¿ç”¨`Vue.extend`ç®€å•å®ç°ä¸‹`$Message`ã€‚<br>
>å…ˆå™è¿°ä¸‹æ¦‚å¿µğŸ˜„ï¼š ç”¨åŸºç¡€ Vue æ„é€ å™¨ï¼Œåˆ›å»ºä¸€ä¸ªâ€œå­ç±»â€ã€‚å‚æ•°æ˜¯ä¸€ä¸ªåŒ…å«ç»„ä»¶é€‰é¡¹çš„å¯¹è±¡ã€‚<br>[è¯¦æƒ…è§å®˜ç½‘](https://cn.vuejs.org/v2/api/#Vue-extend)ã€‚<br>[å®Œæ•´ä»£ç åœ°å€](https://github.com/hz199/__/blob/master/demo/vue/vue.extend%E7%BB%84%E4%BB%B6.html)



### 1. åˆ›å»ºæ¨¡æ¿

åˆ›å»ºä¸€ä¸ªé€šç”¨æ¨¡æ¿ç”¨æ¥ä¾›æˆ‘ä»¬åˆ›å»ºå­ç±»
```js
/******************* æ¨¡æ¿ *******************/
const MessageTemplate = {
  name: 'MessageTemplate',
  template: `
        <transition name="messageFade" @after-leave="afterLeave" @after-enter="afterEnter">
          <div class="msg-wrapper"
          v-show="visibleShow"
          :style="style">
            <div class="msg-content">
              {{text}}
            </div>
          </div>
        </transition>`,
  props: {
    text: {
      type: String,
      default: ''
    }
  },
  data() {
    return {
      // å½“å‰ç»„ä»¶çš„ä¸Šåç§»é‡
      verticalOffset: 0,
      // æ˜¯å¦æ˜¾ç¤º
      visibleShow: true,
      // åˆ›å»ºå®šæ—¶å™¨çš„äº‹ä»¶
      closeTime: 3000,
      timer: null
    }
  },
  // è®¡ç®—å±æ€§ è·å–æœ€æ–°çš„TOP
  computed: {
    style() {
      return {}
    }
  },
  methods: {
    // åŠ¨ç”» transition ç»“æŸæ—¶è§¦å‘å…³é—­åŠ¨ä½œï¼Œæ³¨é”€å½“å‰ç»„ä»¶ã€‚ä» body é‡Œç§»é™¤DOM é‡Šæ”¾å†…å­˜ã€‚
    afterLeave() { },
    afterEnter() { },
    createTimer() {
      if (this.closeTime) {
        this.timer = setTimeout(() => {
          this.visibleShow = false
        }, this.closeTime)
      }
    },
    clearTime() {
      if (this.timer) {
        clearTimeout(this.timer)
      }
    }
  },
  // ç»„ä»¶é”€æ¯å‰ æ¸…é™¤å®šæ—¶å™¨
  beforeDestroy() {
    this.clearTime()
  },
  mounted() {
    this.createTimer()
  }
}
```

### 2. æ¨¡æ¿ Constructor

è¿™é‡Œé¢åˆ›å»ºä¸€ä¸ª Constructor, extends å…è®¸å£°æ˜æ‰©å±•å¦ä¸€ä¸ªç»„ä»¶ï¼Œé‡Œé¢çš„å‚æ•° ç±»è¯•computedçš„styleè®¡ç®—å±æ€§ä¼šè¢«è¦†ç›–æ‰©å±•ã€‚

```js
/******************* æ¨¡æ¿ Constructor *******************/

// MessageTemplate æ¨¡æ¿ æ‰©å±• Vueç»„ä»¶
// è¿™ä¸ªå¯¹è±¡é‡Œé¢çš„å‚æ•° ä¼šè¦†ç›– æ¨¡æ¿é‡Œé¢çš„å‚æ•° data compute methods ...ï¼Œ å¦‚æœæ¨¡æ¿é‡Œé¢è¦ä½¿ç”¨æ‰©å±•çš„å‚æ•° æ¨¡æ¿é‡Œé¢å¿…é¡»ä¼˜å…ˆå£°æ˜æˆ–å‡½æ•°å®šä¹‰ã€‚
const templateConstructor = {
  extends: MessageTemplate,
  data() {
    return {
      // å‚ç›´æ–¹å‘ä¸¤ä¸ªMessage ä¹‹é—´çš„è·ç¦»
      verticalOffset: 0,
      visibleShow: false, // æ‰©å±•åå…ƒç´  é»˜è®¤æ˜¯ ä¸æ˜¾ç¤ºçš„ä¸ºäº†è§¦å‘ transition åŠ¨ç”»
    }
  },
  computed: {
    style() {
      return {
        top: `${this.verticalOffset}px`
      }
    }
  },
  methods: {
    afterLeave() {
      this.$emit('closed')
    }
  }
}

```

### 3. æ‰§è¡Œå‡½æ•°
```js
/******************* è°ƒç”¨å‡½æ•° *******************/
const INSTANCES = [] // ä¸€å †å®ä¾‹å¯¹è±¡ï¼Œç”¨äºæ“ä½œä½ç½®
let INSTANCEID = 1
const OFFSET = 16 // ä¸¤è€…ä¸Šä¸‹ä¹‹é—´çš„é—´è·

/**
 * åˆ é™¤å½“å‰ instance å¯¹è±¡
 * @param [currentInstance] è¦åˆ é™¤çš„å®ä¾‹
 */
const removeInstance = (currentInstance) => {
  if (!currentInstance) return
  // å½“å‰domçš„ç´¢å¼•
  const index = INSTANCES.findIndex(instance => instance.id === currentInstance.id)

  INSTANCES.splice(index, 1)

  if (INSTANCES.length <= 1) return
  for (let i = index; i < INSTANCES.length - 1; i++) {
    INSTANCES[i].verticalOffset = parseInt(INSTANCES[i].verticalOffset) - OFFSET
  }
}

// vue.extend åˆ›å»ºå­ç±»
const MessageConstructor = Vue.extend(templateConstructor)
/**
 * @param option {text: 'æç¤ºä¿¡æ¯'}
 */
const $Message = (option) => {
  // å®ä¾‹å­ç±»
  const instance = new MessageConstructor({
    propsData: option
  })

  // è®¾ç½®å½“å‰å®ä¾‹çš„ID
  const id = `$Message${INSTANCEID++}`
  instance.id = id
  // $mount() æ–¹æ³•ä¸ç©¿å‚æ•°è¿”å›å½“å‰å®ä¾‹å¯¹è±¡ ä¸ä¼šæŒ‚è½½åˆ°DOMé‡Œé¢
  instance.vm = instance.$mount()
  instance.vm.$el.id = id
  document.body.appendChild(instance.vm.$el)
  instance.vm.visibleShow = true // é»˜è®¤ä¸º ä¸æ˜¾ç¤º è¿™é‡Œä¿®æ”¹ä¸ºæ˜¾ç¤º è§¦å‘ transition åŠ¨ç”»

  // è®¾ç½® é«˜åº¦åç§»é‡
  let verticalOffset = 0
  INSTANCES.forEach(item => {
    verticalOffset += OFFSET
  })
  instance.verticalOffset = verticalOffset
  // push å½“å‰VM åˆ° INSTANCES
  INSTANCES.push(instance.vm)

  // transition @after-enter åŠ¨ç”»ç»“æŸåè°ƒç”¨closedåˆ é™¤ INSTANCES ä¸­çš„æ•°æ®ï¼Œç§»å‡ºbodyçš„dom é”€æ¯è¦åˆ é™¤çš„ç»„ä»¶
  instance.vm.$on('closed', () => {
    removeInstance(instance)
    document.body.removeChild(instance.vm.$el)
    instance.vm.$destroy()
  })

  // è¿”å›å½“å‰ç»„ä»¶Vm
  return instance.vm
}

const $MessageCtrl = {
  install (Vue) {
    Vue.prototype.$Message = $Message
  }
}
```

### 4. å®é™…ä½¿ç”¨

```js

Vue.use($MessageCtrl)

new Vue({
  el: '#app',
  methods: {
    clickFunc() {
      this.$Message({
        text: `${Math.random()}`
      })
    }
  }
})

```